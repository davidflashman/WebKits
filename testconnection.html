// Simplified Google Apps Script - Replace YOUR_SHEET_ID
const SHEET_ID = '1zyONkhPJsJl6Cs_SY3Z4n3N_zH0myDG9D5zeSA3vyys';

function doGet(e) {
  try {
    const sheetName = e.parameter.sheet || 'Sheet40';
    console.log('GET request for sheet:', sheetName);
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(sheetName);
    if (!sheet) {
      throw new Error(`Sheet "${sheetName}" not found`);
    }
    
    const data = sheet.getDataRange().getValues();
    console.log('Retrieved data rows:', data.length);
    
    return createResponse({
      success: true,
      data: data,
      rows: data.length
    });
    
  } catch (error) {
    console.error('GET Error:', error);
    return createResponse({
      success: false,
      error: error.message
    });
  }
}

function doPost(e) {
  try {
    console.log('POST request received');
    const data = JSON.parse(e.postData.contents);
    console.log('Parsed data:', data);
    
    const sheetName = data.sheetName || 'Sheet1';
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(sheetName);
    
    if (!sheet) {
      throw new Error(`Sheet "${sheetName}" not found`);
    }
    
    if (data.action === 'append' && data.values) {
      sheet.appendRow(data.values);
      console.log('Row appended:', data.values);
      
      return createResponse({
        success: true,
        message: 'Row added successfully'
      });
    }
    
    if (data.action === 'update' && data.row && data.values) {
      const range = sheet.getRange(data.row, 1, 1, data.values.length);
      range.setValues([data.values]);
      console.log('Row updated:', data.row, data.values);
      
      return createResponse({
        success: true,
        message: `Row ${data.row} updated successfully`
      });
    }
    
    throw new Error('Invalid action or missing data');
    
  } catch (error) {
    console.error('POST Error:', error);
    return createResponse({
      success: false,
      error: error.message
    });
  }
}

function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

// Handle CORS preflight
function doOptions() {
  return createResponse({});
}
